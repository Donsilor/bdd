<?php


namespace api\modules\web\forms;


use common\models\order\Order;
use common\models\order\OrderTourist;
use common\models\pay\WireTransfer;

class WireTransferForm extends WireTransfer
{
    /**
     * {@inheritdoc}
     */
    public function rules()
    {
        return [
            [['order_sn', 'account', 'payment_voucher'], 'required'],
            ['order_sn', 'validateOrderSn'],
            [['account', 'payment_serial_number'], 'string', 'max' => 50],
            ['account', 'validateAccount'],
            [['payment_voucher'], 'string', 'max' => 255],
            ['payment_voucher', 'url'],
        ];
    }

    /**
     * {@inheritdoc}
     */
    public function attributeLabels()
    {
        return [
            'order_sn' => '订单编号',
            'member_id' => '订单ID',
            'account' => '收款账号',
            'payment_serial_number' => '付款流水号',//payment_serial_number
            'payment_voucher' => '付款凭证图片',
        ];
    }

    public function validateAccount($attribute)
    {

        $configJson = \Yii::$app->debris->config('pay_collection_account_info');
        $configs = \Qiniu\json_decode($configJson, true);

        $bankInfo = [];
        foreach ($configs as $config) {
            if($config['account']==$this->account) {
                $bankInfo = $config;
            }
        }

        if (empty($bankInfo)) {
            $this->addError($attribute, '收款银行账号错误');
            return;
        }

        $this->bank_name = $bankInfo['bank_name_cn'];
        $this->account_name = $bankInfo['account_name'];
        $this->opening_bank = $bankInfo['opening_bank'];
    }

    public function validateOrderSn($attribute)
    {
        if($this->member_id) {
            if(!Order::findOne(['order_sn'=>$this->order_sn, 'member_id'=>$this->member_id])) {
                $this->addError($attribute, '订单ID错误');
            }
        }
        else {
            if(!OrderTourist::findOne(['order_sn'=>$this->order_sn])) {
                $this->addError($attribute, '游客订单ID错误');
            }
        }
    }

    public function afterSave($insert, $changedAttributes)
    {
        parent::afterSave($insert, $changedAttributes); // TODO: Change the autogenerated stub
    }
}